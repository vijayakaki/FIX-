<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIX$ - GeoEquity Impact Engine</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            color: #667eea;
            font-weight: 700;
        }

        .header .subtitle {
            font-size: 14px;
            color: #666;
            margin-top: 2px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info span {
            color: #333;
            font-size: 14px;
        }

        .logout-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #5568d3;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 380px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 100;
        }

        .search-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .search-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            color: #555;
            font-size: 13px;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .search-btn:hover {
            background: #5568d3;
        }

        .search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .results {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .results h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .result-text {
            color: #666;
            font-size: 13px;
            line-height: 1.5;
        }

        .store-list {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .store-item {
            padding: 12px;
            background: #f8f9fa;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 4px solid #667eea;
        }

        .store-item:hover {
            background: #e9ecef;
        }

        .store-item.supermarket {
            border-left-color: #28a745;
        }

        .store-item.pharmacy {
            border-left-color: #dc3545;
        }

        .store-item.restaurant {
            border-left-color: #ffc107;
        }

        .store-item.convenience {
            border-left-color: #17a2b8;
        }

        .store-item.warehouse {
            border-left-color: #9c27b0;
        }

        .store-name {
            font-weight: 600;
            color: #333;
            font-size: 13px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .store-icon {
            font-size: 16px;
        }

        .store-address {
            font-size: 12px;
            color: #666;
        }

        .ejv-score {
            display: inline-block;
            padding: 4px 10px;
            background: #667eea;
            color: white;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 5px;
        }

        /* Dashboard Panel */
        .dashboard-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #667eea;
        }

        .dashboard-header {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }

        .dashboard-header h3 {
            color: #667eea;
            font-size: 16px;
            font-weight: 700;
            margin: 0;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .stat-card {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 10px;
            color: #666;
            margin-top: 3px;
            text-transform: uppercase;
        }

        .wealth-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .wealth-card {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .wealth-card.retained {
            border-left: 3px solid #28a745;
        }

        .wealth-card.leakage {
            border-left: 3px solid #dc3545;
        }

        .wealth-value {
            font-size: 16px;
            font-weight: 700;
        }

        .wealth-card.retained .wealth-value {
            color: #28a745;
        }

        .wealth-card.leakage .wealth-value {
            color: #dc3545;
        }

        .wealth-label {
            font-size: 10px;
            color: #666;
            margin-top: 3px;
        }

        .dimensions-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
            margin-top: 10px;
        }

        .dimension-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            border-left: 3px solid #667eea;
        }

        .dimension-name {
            color: #333;
            font-weight: 600;
            flex: 1;
        }

        .dimension-value {
            color: #667eea;
            font-weight: 700;
            font-size: 12px;
        }

        .dimensions-header {
            font-size: 12px;
            font-weight: 600;
            color: #333;
            margin: 10px 0 5px 0;
        }

        .score-breakdown {
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 11px;
            border-bottom: 1px solid #f0f0f0;
        }

        .score-item:last-child {
            border-bottom: none;
        }

        .score-item-label {
            color: #666;
        }

        .score-item-value {
            font-weight: 700;
            color: #667eea;
        }

        .decision-step:hover {
            background: #f0f8ff !important;
            transform: scale(1.02);
            transition: all 0.2s;
        }

        .decision-step.active {
            background: #e3f2fd !important;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        /* Impact Circle Visualization */
        .impact-circle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            z-index: 500;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.9;
            }
            100% {
                transform: scale(1);
                opacity: 0.7;
            }
        }

        .impact-high {
            background: radial-gradient(circle, rgba(40, 167, 69, 0.3) 0%, rgba(40, 167, 69, 0) 70%);
            box-shadow: 0 0 40px rgba(40, 167, 69, 0.6);
        }

        .impact-medium {
            background: radial-gradient(circle, rgba(255, 193, 7, 0.3) 0%, rgba(255, 193, 7, 0) 70%);
            box-shadow: 0 0 40px rgba(255, 193, 7, 0.6);
        }

        .impact-low {
            background: radial-gradient(circle, rgba(220, 53, 69, 0.3) 0%, rgba(220, 53, 69, 0) 70%);
            box-shadow: 0 0 40px rgba(220, 53, 69, 0.6);
        }

        .legend h4 {
            font-size: 12px;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 11px;
            color: #666;
        }

        .legend-icon {
            font-size: 16px;
        }

        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
            background: #e0e0e0;
            min-width: 0;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #a8d5e2;
        }

        /* Custom Marker Styles */
        .custom-marker {
            background: transparent !important;
            border: none !important;
            cursor: pointer;
            z-index: 1000 !important;
        }

        .leaflet-marker-icon.custom-marker {
            display: flex !important;
            align-items: center;
            justify-content: center;
            pointer-events: auto !important;
        }
        
        .leaflet-marker-icon {
            z-index: 1000 !important;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

        .login-screen::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: moveBackground 20s linear infinite;
        }

        @keyframes moveBackground {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        .login-box {
            background: rgba(255, 255, 255, 0.98);
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 450px;
            position: relative;
            z-index: 1;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-box h2 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 32px;
            font-weight: 700;
            text-align: center;
        }

        .login-box p {
            color: #666;
            margin-bottom: 35px;
            font-size: 15px;
            text-align: center;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .form-group input::placeholder {
            color: #aaa;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
            position: relative;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .login-btn.loading::after {
            content: '';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: translateY(-50%) rotate(360deg); }
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 15px;
            padding: 12px;
            background: #ffe6e6;
            border-radius: 6px;
            border-left: 4px solid #dc3545;
            display: none;
            animation: shake 0.4s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .error-message.active {
            display: block;
        }

        .login-info {
            text-align: center;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid #e0e0e0;
        }

        .login-info p {
            color: #999;
            font-size: 12px;
            margin: 5px 0;
        }

        .login-info strong {
            color: #667eea;
            font-weight: 600;
        }

        /* Help Modal Styles */
        .help-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .help-modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .help-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 12px 12px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .help-modal-header h2 {
            margin: 0;
            font-size: 26px;
            font-weight: 700;
        }

        .help-modal-header p {
            margin: 8px 0 0 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .help-close {
            position: absolute;
            top: 20px;
            right: 25px;
            color: white;
            font-size: 32px;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.3s;
            line-height: 1;
        }

        .help-close:hover {
            transform: rotate(90deg);
            opacity: 0.8;
        }

        .help-modal-body {
            padding: 30px;
        }

        .help-section {
            margin-bottom: 30px;
        }

        .help-section h3 {
            color: #667eea;
            font-size: 18px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        .help-formula {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin: 15px 0;
        }

        .help-formula code {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #333;
            font-weight: 600;
        }

        .help-formula p {
            margin: 8px 0 0 0;
            color: #666;
            font-size: 13px;
        }

        .help-component {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .help-component h4 {
            color: #333;
            font-size: 15px;
            margin: 0 0 10px 0;
        }

        .help-component p {
            color: #666;
            font-size: 13px;
            line-height: 1.6;
            margin: 8px 0;
        }

        .help-component ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .help-component li {
            color: #666;
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 5px;
        }

        .help-data-source {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #28a745;
        }

        .help-data-source strong {
            color: #333;
            font-size: 14px;
        }

        .help-data-source p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 12px;
        }

        .help-data-source a {
            color: #667eea;
            text-decoration: none;
            font-size: 11px;
        }

        .help-data-source a:hover {
            text-decoration: underline;
        }

        .help-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid currentColor;
            color: #667eea;
            cursor: pointer;
            font-size: 18px;
            padding: 6px 10px;
            border-radius: 50%;
            transition: all 0.3s;
            vertical-align: middle;
            margin-left: 8px;
            display: inline-block;
            line-height: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .help-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.2) rotate(15deg);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .help-btn:active {
            transform: scale(1.1) rotate(15deg);
        }

        .help-insight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
        }

        .help-interpretation {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .help-interpretation-item {
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
        }

        .help-interpretation-item.excellent {
            background: #d4edda;
            border: 1px solid #28a745;
        }

        .help-interpretation-item.good {
            background: #d1ecf1;
            border: 1px solid #17a2b8;
        }

        .help-interpretation-item.fair {
            background: #fff3cd;
            border: 1px solid #ffc107;
        }

        .help-interpretation-item.poor {
            background: #f8d7da;
            border: 1px solid #dc3545;
        }
    </style>
</head>
<body>
    <!-- Main Application -->
    <div id="mainApp" class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>FIX$ GeoEquity Impact Engine</h1>
                <div class="subtitle">Geo-Contextual Decision Intelligence System</div>
            </div>
            <div class="user-info">
                <span id="userDisplay">Loading...</span>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Instructions -->
                <div style="margin-bottom: 15px; padding: 12px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 5px;">
                    <p style="margin: 0; font-size: 13px; color: #2e7d32; line-height: 1.5;">
                        <strong>‚úì 8 demo stores loaded!</strong><br>
                        Search by ZIP or address below to find real stores anywhere in the USA.
                    </p>
                </div>
                
                <!-- ZIP Code Search -->
                <div class="search-section">
                    <h3>üîç Search by ZIP Code</h3>
                    <div class="input-group">
                        <label>ZIP Code</label>
                        <input type="text" id="zipInput" placeholder="e.g., 10001">
                    </div>
                    <div class="input-group">
                        <label>Search Radius</label>
                        <select id="zipRadius">
                            <option value="1">1 mile</option>
                            <option value="2" selected>2 miles</option>
                            <option value="3">3 miles</option>
                            <option value="5">5 miles</option>
                            <option value="10">10 miles</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Store Category</label>
                        <select id="zipCategory" onchange="toggleCustomSearch('zip')">
                            <option value="all">üè™ All Stores & Businesses</option>
                            <option value="supermarket">üõí Supermarkets & Grocery Stores</option>
                            <option value="pharmacy">üíä Pharmacies & Drugstores</option>
                            <option value="restaurant">üçΩÔ∏è Restaurants & Fast Food</option>
                            <option value="convenience">üè™ Convenience Stores</option>
                            <option value="coffee">‚òï Coffee Shops & Cafes</option>
                            <option value="electronics">üì± Electronics Stores</option>
                            <option value="custom">‚úèÔ∏è Custom Search...</option>
                        </select>
                    </div>
                    <div class="input-group" id="zipCustomSearch" style="display: none;">
                        <label>Custom Business Type</label>
                        <input type="text" id="zipCustomInput" placeholder="e.g., bookstore, gym, salon">
                        <small style="color: #666; font-size: 11px;">Enter any business type to search</small>
                    </div>
                    <button class="search-btn" onclick="searchByZip()">Search ZIP</button>
                </div>

                <!-- Address Search -->
                <div class="search-section">
                    <h3>üìç Search by Address</h3>
                    <div class="input-group">
                        <label>Address</label>
                        <input type="text" id="addressInput" placeholder="e.g., New York, NY">
                    </div>
                    <div class="input-group">
                        <label>Search Radius</label>
                        <select id="addressRadius">
                            <option value="1">1 mile</option>
                            <option value="2" selected>2 miles</option>
                            <option value="3">3 miles</option>
                            <option value="5">5 miles</option>
                            <option value="10">10 miles</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Store Category</label>
                        <select id="addressCategory" onchange="toggleCustomSearch('address')">
                            <option value="all">üè™ All Stores & Businesses</option>
                            <option value="supermarket">üõí Supermarkets & Grocery Stores</option>
                            <option value="pharmacy">üíä Pharmacies & Drugstores</option>
                            <option value="restaurant">üçΩÔ∏è Restaurants & Fast Food</option>
                            <option value="convenience">üè™ Convenience Stores</option>
                            <option value="coffee">‚òï Coffee Shops & Cafes</option>
                            <option value="electronics">üì± Electronics Stores</option>
                            <option value="custom">‚úèÔ∏è Custom Search...</option>
                        </select>
                    </div>
                    <div class="input-group" id="addressCustomSearch" style="display: none;">
                        <label>Custom Business Type</label>
                        <input type="text" id="addressCustomInput" placeholder="e.g., bookstore, gym, salon">
                        <small style="color: #666; font-size: 11px;">Enter any business type to search</small>
                    </div>
                    <button class="search-btn" onclick="searchByAddress()">Search Address</button>
                </div>

                <!-- Decision Loop -->
                <div class="dashboard-panel" id="decisionLoop" style="margin: 0 auto; max-width: 340px;">
                    <div class="dashboard-header">
                        <h3 style="text-align: center;">üîÑ Decision Loop</h3>
                    </div>
                    <div style="font-size: 11px; color: #666; line-height: 1.6;">
                        <div class="decision-step" data-mode="locator" onclick="setDecisionMode('locator')" style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #667eea; cursor: pointer;">
                            <strong style="color: #667eea;">üìç LOCATOR</strong><br>
                            Find all businesses in your target area for your purchase needs
                        </div>
                        <div class="decision-step" data-mode="compare" onclick="setDecisionMode('compare')" style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #28a745; cursor: pointer;">
                            <strong style="color: #28a745;">‚öñÔ∏è COMPARE</strong><br>
                            Compare EJV scores across different stores
                        </div>
                        <div class="decision-step" data-mode="optimize" onclick="setDecisionMode('optimize')" style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #ffc107; cursor: pointer;">
                            <strong style="color: #ffc107;">‚ú® OPTIMIZE</strong><br>
                            Get recommendations for best and least impact stores
                        </div>
                        <div class="decision-step" data-mode="engage" onclick="setDecisionMode('engage')" style="background: white; padding: 10px; border-radius: 6px; border-left: 3px solid #ff5722; cursor: pointer;">
                            <strong style="color: #ff5722;">ü§ù ENGAGE</strong><br>
                            Amplify impact through participation (EJV v4.2)
                        </div>
                    </div>
                    <div id="modeDisplay" style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 6px; font-size: 11px; display: none;">
                        <strong id="currentMode" style="color: #667eea;">Current Mode: Locator</strong>
                    </div>
                </div>

                <!-- Results -->
                <div class="results">
                    <h4>Search Results</h4>
                    <div class="result-text" id="resultText">Enter a ZIP code or address to search for stores</div>
                    <div class="store-list" id="storeList"></div>
                </div>
            </div>

            <!-- Map -->
            <div class="map-container">
                <div id="map"></div>
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="spinner"></div>
                </div>
                
                <!-- Right Side Dashboard -->
                <div id="rightDashboard" style="position: absolute; top: 20px; right: 20px; width: 450px; background: white; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); padding: 20px; max-height: calc(100vh - 200px); overflow-y: auto; display: block; z-index: 1000;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea;">
                        <h3 style="color: #667eea; font-size: 16px; margin: 0;">üìä EJV Dashboard</h3>
                        <button onclick="closeRightDashboard()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #999;">&times;</button>
                    </div>
                    
                    <div id="storeInfoHeader" style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 12px; font-size: 12px;">
                        <strong id="storeNameDisplay" style="color: #333;">Hover over a store to see details</strong><br>
                        <small id="storeLocationDisplay" style="color: #666;">Search for stores using ZIP code or address</small>
                    </div>
                    
                    <div id="mainMetricsGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                        <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 10px; border-radius: 6px; text-align: center; border: 2px solid #9c27b0; position: relative;">
                            <div id="ejvV2Display" style="font-size: 20px; font-weight: 700; color: #7b1fa2;">-</div>
                            <div style="font-size: 9px; color: #4a148c; margin-top: 2px; text-transform: uppercase; font-weight: 600;">
                                EJV v2 (Baseline)
                            </div>
                            <button class="help-btn" onclick="showHelpModal('v2')" title="Learn about EJV v2 - 9 Dimensions Baseline - Click for details" style="position: absolute; top: 6px; right: 6px;">‚ùì</button>
                        </div>
                        <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 10px; border-radius: 6px; text-align: center; border: 2px solid #2196f3; position: relative;">
                            <div id="ejvV41Display" style="font-size: 20px; font-weight: 700; color: #1976d2;">-</div>
                            <div style="font-size: 9px; color: #0d47a1; margin-top: 2px; text-transform: uppercase; font-weight: 600;" title="Estimated Local Value Retained - Dollar amount staying in local economy">
                                EJV v4.1 ($)
                            </div>
                            <button class="help-btn" onclick="showHelpModal('v4.1')" title="Learn about EJV v4.1 - Decomposed Flows (Wages 35%, Suppliers 25%, Taxes 15%, Financing 15%, Ownership 10%) - Click for details" style="position: absolute; top: 6px; right: 6px;">‚ùì</button>
                        </div>
                    </div>
                    
                    <div id="engageMetricsGrid" style="display: none; grid-template-columns: 1fr; gap: 8px; margin-bottom: 12px;">
                        <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 10px; border-radius: 6px; text-align: center; border: 2px solid #4caf50; position: relative;">
                            <div id="ejvV42Display" style="font-size: 20px; font-weight: 700; color: #2e7d32;">-</div>
                            <div style="font-size: 9px; color: #1b5e20; margin-top: 2px; text-transform: uppercase; font-weight: 600;">
                                EJV v4.2 (Participation)
                            </div>
                            <button class="help-btn" onclick="showHelpModal('v4.2')" title="Learn about EJV v4.2 - Participation Amplification - Click for details" style="position: absolute; top: 6px; right: 6px;">‚ùì</button>
                        </div>
                    </div>
                    
                    <div id="participationPanel" style="background: #fff3e0; padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid #ff9800; display: none;">
                        <div style="font-size: 11px; font-weight: 600; color: #e65100; margin-bottom: 8px;">ü§ù Participation Amplification</div>
                        <div style="display: flex; justify-content: space-between; padding: 5px 0; font-size: 10px;">
                            <span style="color: #666;">PAF (Amplification Factor)</span>
                            <span id="pafDisplay" style="font-weight: 700; color: #ff6f00;">1.00√ó</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 5px 0; font-size: 10px; border-top: 1px solid #ffe0b2; padding-top: 5px; margin-top: 5px;">
                            <span style="color: #666;">Amplification Value</span>
                            <span id="ampValueDisplay" style="font-weight: 700; color: #4caf50;">$0.00</span>
                        </div>
                        <div id="participationActivities" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #ffe0b2; font-size: 9px; color: #666;"></div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center; border-left: 3px solid #28a745;">
                            <div id="wealthRetained" style="font-size: 16px; font-weight: 700; color: #28a745;">0%</div>
                            <div style="font-size: 9px; color: #666; margin-top: 3px; cursor: help;" title="Percentage of purchase value that stays in the local economy through wages, suppliers, taxes, financing, and ownership">Estimated Local Retention (%)</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center; border-left: 3px solid #dc3545;">
                            <div id="wealthLeakage" style="font-size: 16px; font-weight: 700; color: #dc3545;">0%</div>
                            <div style="font-size: 9px; color: #666; margin-top: 3px; cursor: help;" title="Percentage of purchase value that leaves the local economy to external suppliers, headquarters, and investors">Estimated Leakage (%)</div>
                        </div>
                    </div>
                    
                    <div id="scoreBreakdown" style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 12px;">
                        <div style="font-size: 11px; font-weight: 600; color: #333; margin-bottom: 8px;">Score Components (0-25 each)</div>
                        <div style="display: flex; justify-content: space-between; padding: 5px 0; font-size: 10px; border-bottom: 1px solid #e0e0e0;">
                            <span style="color: #666;">Wage Score</span>
                            <span id="wageScore" style="font-weight: 700; color: #667eea;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 5px 0; font-size: 10px; border-bottom: 1px solid #e0e0e0;">
                            <span style="color: #666;">Hiring Score</span>
                            <span id="hiringScore" style="font-weight: 700; color: #667eea;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 5px 0; font-size: 10px; border-bottom: 1px solid #e0e0e0;">
                            <span style="color: #666;">Community Score</span>
                            <span id="communityScore" style="font-weight: 700; color: #667eea;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 5px 0; font-size: 10px;">
                            <span style="color: #666;">Participation Score</span>
                            <span id="participationScore" style="font-weight: 700; color: #667eea;">-</span>
                        </div>
                    </div>
                    
                    <div id="dimensionsGrid" style="margin-bottom: 12px;">
                        <div style="font-size: 11px; font-weight: 600; color: #333; margin-bottom: 8px;">9 Justice Dimensions</div>
                        <div id="dimensionsList" style="display: grid; grid-template-columns: 1fr; gap: 4px;"></div>
                    </div>
                    
                    <div id="formulaDisplay" style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                        <strong style="color: #667eea; font-size: 10px;">üìê Formula:</strong>
                        <div id="formulaText" style="color: #666; margin-top: 5px; font-family: monospace; font-size: 9px;"></div>
                    </div>
                    
                    <div id="dataSourcesDisplay" style="background: #f8f9fa; padding: 10px; border-radius: 6px; font-size: 9px;">
                        <strong style="color: #667eea; font-size: 10px;">üìä Data Sources:</strong>
                        <ul id="dataSourcesList" style="margin: 5px 0 0 15px; padding: 0; color: #666;"></ul>
                    </div>
                </div>
                
                <!-- Legend -->
                <div class="legend">
                    <h4>Store Categories</h4>
                    <div class="legend-item">
                        <span class="legend-icon">üõí</span>
                        <span>Supermarket</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-icon">üè¢</span>
                        <span>Warehouse Club</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-icon">üíä</span>
                        <span>Pharmacy</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-icon">üçΩÔ∏è</span>
                        <span>Restaurant</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-icon">üè™</span>
                        <span>Convenience</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-icon">üè¨</span>
                        <span>Other Stores</span>
                    </div>
                    <hr style="margin: 10px 0; border: none; border-top: 1px solid #e0e0e0;">
                    <!-- Updated Legend: 4-tier Economic Justice Impact -->
                    <h4 style="margin-top: 10px;">Economic Justice Impact</h4>
                    <div class="legend-item">
                        <span style="display: inline-block; width: 14px; height: 14px; background: linear-gradient(135deg, #c8e6c9, #a5d6a7); border: 1px solid #4caf50; border-radius: 3px; margin-right: 5px;"></span>
                        <span style="font-size: 10px; font-weight: 600; color: #1b5e20;">üåü Excellent (75-100)</span>
                    </div>
                    <div class="legend-item">
                        <span style="display: inline-block; width: 14px; height: 14px; background: linear-gradient(135deg, #b3e5fc, #81d4fa); border: 1px solid #03a9f4; border-radius: 3px; margin-right: 5px;"></span>
                        <span style="font-size: 10px; font-weight: 600; color: #01579b;">üëç Good (50-74)</span>
                    </div>
                    <div class="legend-item">
                        <span style="display: inline-block; width: 14px; height: 14px; background: linear-gradient(135deg, #ffe0b2, #ffcc80); border: 1px solid #ff9800; border-radius: 3px; margin-right: 5px;"></span>
                        <span style="font-size: 10px; font-weight: 600; color: #e65100;">‚ö†Ô∏è Fair (25-49)</span>
                    </div>
                    <div class="legend-item">
                        <span style="display: inline-block; width: 14px; height: 14px; background: linear-gradient(135deg, #ffcdd2, #ef9a9a); border: 1px solid #f44336; border-radius: 3px; margin-right: 5px;"></span>
                        <span style="font-size: 10px; font-weight: 600; color: #b71c1c;">‚ö° Poor (0-24)</span>
                    </div>
                    <div style="font-size: 9px; color: #666; margin-top: 5px; font-style: italic;">
                        Hover over stores to see impact grid
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ===== NO AUTHENTICATION REQUIRED =====
        // App is publicly accessible
        console.log('‚úì FIX$ GeoEquity Impact Engine loaded');
        
        // Dummy logout function (just refreshes page)
        function logout() {
            window.location.reload();
        }
        
        let map;
        let markers = [];
        let currentUser = { username: 'Guest User', email: 'guest@fixapp.com' };
        let storeData = [];
        let rawStores = []; // Raw store data from search for re-rendering
        let ejvData = {};
        let decisionMode = 'locator';
        let allStoresEJV = [];
        let ejvCache = {}; // Cache EJV calculations by store ID
        let hoverDebounceTimer = null; // Debounce hover events
        let currentZip = '10001'; // Default ZIP code, updated on search

        // ==========================================
        // EJV v4.2: PAF Calculation
        // ==========================================
        const PARTICIPATION_TYPES = {
            mentoring: { weight: 0.08 },
            volunteering: { weight: 0.06 },
            sponsorship: { weight: 0.05 },
            apprenticeship: { weight: 0.04 },
            facilities: { weight: 0.02 }
        };

        function calculatePAF(participationData) {
            if (!participationData || Object.keys(participationData).length === 0) {
                return 1.0;
            }
            
            let totalContribution = 0.0;
            
            for (const [activityType, activityData] of Object.entries(participationData)) {
                if (!PARTICIPATION_TYPES[activityType]) continue;
                
                const baseWeight = PARTICIPATION_TYPES[activityType].weight;
                const intensity = Math.min((activityData.hours || 1) / 10.0, 1.0);
                const verificationMultiplier = activityData.verified ? 1.2 : 1.0;
                const durationFactor = Math.min((activityData.duration_months || 1) / 12.0, 1.0);
                
                const contribution = baseWeight * intensity * verificationMultiplier * durationFactor;
                totalContribution += contribution;
            }
            
            const paf = 1.0 + Math.min(totalContribution, 0.25);
            return Number(paf.toFixed(3));
        }

        // Custom marker icons
        const storeIcons = {
            supermarket: { icon: 'üõí', color: '#1e7e34' },
            warehouse: { icon: 'üè¢', color: '#6a1b9a' },
            pharmacy: { icon: 'üíä', color: '#bd2130' },
            restaurant: { icon: 'üçΩÔ∏è', color: '#d39e00' },
            convenience: { icon: 'üè™', color: '#117a8b' },
            default: { icon: 'üè¨', color: '#4a5bb8' }
        };

        function getStoreIcon(shopType) {
            return storeIcons[shopType] || storeIcons.default;
        }

        function setDecisionMode(mode) {
            decisionMode = mode;
            document.querySelectorAll('.decision-step').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            const modeDisplay = document.getElementById('modeDisplay');
            const currentModeText = document.getElementById('currentMode');
            modeDisplay.style.display = 'block';
            
            // Show/hide v4.2 metrics based on mode
            const engageMetrics = document.getElementById('engageMetricsGrid');
            
            if (mode === 'locator') {
                currentModeText.innerHTML = 'üìç Locator Mode: Hover on stores to see details';
                currentModeText.style.color = '#667eea';
                engageMetrics.style.display = 'none';
                // Re-display stores if they exist
                if (rawStores.length > 0) {
                    const storeListDiv = document.getElementById('storeList');
                    storeListDiv.innerHTML = ''; // Clear ENGAGE/COMPARE content
                    displayStores(rawStores); // Re-render store list
                    showResult(`Found ${rawStores.length} stores`);
                } else {
                    showResult('Enter a ZIP code or address to search for stores');
                }
            } else if (mode === 'compare') {
                currentModeText.innerHTML = '‚öñÔ∏è Compare Mode: Viewing all calculated EJV scores';
                currentModeText.style.color = '#28a745';
                engageMetrics.style.display = 'none';
                showCompareMode();
            } else if (mode === 'optimize') {
                currentModeText.innerHTML = '‚ú® Optimize Mode: Showing best and least impact';
                currentModeText.style.color = '#ffc107';
                engageMetrics.style.display = 'none';
                showOptimizeMode();
            } else if (mode === 'engage') {
                currentModeText.innerHTML = 'ü§ù Engage Mode: Amplify impact through participation (EJV v4.2)';
                currentModeText.style.color = '#ff5722';
                engageMetrics.style.display = 'grid';
                showEngageMode();
            }
        }

        function showCompareMode() {
            if (allStoresEJV.length === 0) {
                showResult('Calculate EJV for stores first to enable Compare mode');
                return;
            }
            
            const storeListDiv = document.getElementById('storeList');
            storeListDiv.innerHTML = '<div style="font-size: 12px; font-weight: 600; margin-bottom: 10px; color: #28a745;">Comparing ' + allStoresEJV.length + ' stores:</div>';
            
            // Sort by ELVR (v4.1 retained value)
            const sorted = [...allStoresEJV].sort((a, b) => (b.elvr || 0) - (a.elvr || 0));
            
            sorted.forEach((store, index) => {
                const storeItem = document.createElement('div');
                storeItem.className = 'store-item';
                storeItem.style.borderLeftColor = getStoreIcon(store.type).color;
                storeItem.innerHTML = `
                    <div class="store-name">
                        <span class="store-icon">${getStoreIcon(store.type).icon}</span>
                        #${index + 1} - ${store.name}
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <span style="font-size: 11px; background: #667eea; color: white; padding: 3px 8px; border-radius: 3px;">ELVR: $${(store.elvr || 0).toFixed(2)}</span>
                        <span style="font-size: 11px; background: #dc3545; color: white; padding: 3px 8px; border-radius: 3px;">EVL: $${(store.evl || 0).toFixed(2)}</span>
                        <span style="font-size: 11px; background: #28a745; color: white; padding: 3px 8px; border-radius: 3px;">${(store.retention_percentage || 0).toFixed(1)}%</span>
                    </div>
                `;
                storeItem.onclick = () => {
                    map.setView([store.lat, store.lon], 16);
                    updateRightDashboard(store.data, store.name);
                };
                storeListDiv.appendChild(storeItem);
            });
        }

        function showOptimizeMode() {
            if (allStoresEJV.length === 0) {
                showResult('Calculate EJV for stores first to enable Optimize mode');
                return;
            }
            
            const sorted = [...allStoresEJV].sort((a, b) => (b.elvr || 0) - (a.elvr || 0));
            const best = sorted[0];
            const worst = sorted[sorted.length - 1];
            
            const storeListDiv = document.getElementById('storeList');
            storeListDiv.innerHTML = `
                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px; color: #ffc107;">Optimization Results:</div>
                
                <div style="background: #d4edda; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #28a745;">
                    <div style="font-size: 11px; font-weight: 700; color: #155724; margin-bottom: 5px;">üèÜ BEST CHOICE</div>
                    <div style="font-weight: 600; color: #333; margin-bottom: 3px;">${getStoreIcon(best.type).icon} ${best.name}</div>
                    <div style="font-size: 11px; color: #666;">ELVR: $${(best.elvr || 0).toFixed(2)} | EVL: $${(best.evl || 0).toFixed(2)} | Retention: ${(best.retention_percentage || 0).toFixed(1)}%</div>
                    <div style="font-size: 10px; color: #28a745; margin-top: 5px;">‚úì Highest local value retention</div>
                </div>
                
                <div style="background: #f8d7da; padding: 12px; border-radius: 6px; border-left: 4px solid #dc3545;">
                    <div style="font-size: 11px; font-weight: 700; color: #721c24; margin-bottom: 5px;">‚ö†Ô∏è LEAST IMPACT</div>
                    <div style="font-weight: 600; color: #333; margin-bottom: 3px;">${getStoreIcon(worst.type).icon} ${worst.name}</div>
                    <div style="font-size: 11px; color: #666;">ELVR: $${(worst.elvr || 0).toFixed(2)} | EVL: $${(worst.evl || 0).toFixed(2)} | Retention: ${(worst.retention_percentage || 0).toFixed(1)}%</div>
                    <div style="font-size: 10px; color: #dc3545; margin-top: 5px;">‚ö† Lower local value retention</div>
                </div>
            `;
        }

        function showEngageMode() {
            if (allStoresEJV.length === 0) {
                showResult('Calculate EJV for stores first to enable Engage mode');
                return;
            }
            
            const storeListDiv = document.getElementById('storeList');
            storeListDiv.innerHTML = `
                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px; color: #ff5722;">ü§ù Engage: Participation Amplification (EJV v4.2)</div>
                
                <div style="background: #fff3e0; padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid #ff9800;">
                    <div style="font-size: 11px; line-height: 1.6; color: #333;">
                        <strong>How it works:</strong><br>
                        ‚Ä¢ Add verified participation actions<br>
                        ‚Ä¢ PAF multiplier: 1.0 to 1.25 (up to 25% boost)<br>
                        ‚Ä¢ Activities: Mentoring, Volunteering, Sponsorship, Apprenticeships<br>
                        ‚Ä¢ Amplifies EJV v4.1 decomposed flows
                    </div>
                </div>
                
                <div style="font-size: 11px; margin-bottom: 10px; color: #666;">
                    Select a store to add participation activities:
                </div>
            `;
            
            allStoresEJV.forEach(store => {
                const storeItem = document.createElement('div');
                storeItem.className = 'store-item';
                storeItem.style.cursor = 'pointer';
                storeItem.style.padding = '10px';
                storeItem.style.marginBottom = '8px';
                storeItem.style.background = 'white';
                storeItem.style.borderRadius = '6px';
                storeItem.style.borderLeft = '3px solid #ff5722';
                storeItem.innerHTML = `
                    <div style="font-weight: 600; color: #333; margin-bottom: 3px;">${getStoreIcon(store.type).icon} ${store.name}</div>
                    <div style="font-size: 10px; color: #666; margin-bottom: 5px;">
                        Base EJV v2: $${store.ejv_v2.toFixed(2)}
                    </div>
                    <div style="font-size: 10px; color: #ff5722;">
                        Click to apply participation (v4.2)
                    </div>
                `;
                storeItem.onclick = () => showParticipationForm(store);
                storeListDiv.appendChild(storeItem);
            });
        }

        function showParticipationForm(store) {
            const storeListDiv = document.getElementById('storeList');
            storeListDiv.innerHTML = `
                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px; color: #ff5722;">
                    ü§ù ${store.name} - Add Participation
                </div>
                
                <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                    <div style="font-size: 11px; margin-bottom: 8px;">
                        <label style="display: block; margin-bottom: 4px; font-weight: 600;">Mentoring (hrs/week):</label>
                        <input type="number" id="mentoring_hours" min="0" max="10" value="2" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div style="font-size: 11px; margin-bottom: 8px;">
                        <label style="display: block; margin-bottom: 4px; font-weight: 600;">Volunteering (hrs/week):</label>
                        <input type="number" id="volunteering_hours" min="0" max="10" value="4" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div style="font-size: 11px; margin-bottom: 12px;">
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" id="verified" checked style="margin-right: 6px;">
                            <span>Verified by community partner (+20%)</span>
                        </label>
                    </div>
                    
                    <button onclick="calculateEngageEJV('${store.storeId}', '${store.name}', ${store.ejv_v2})" 
                            style="width: 100%; padding: 10px; background: #ff5722; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                        Calculate EJV v4.2
                    </button>
                    
                    <button onclick="showEngageMode()" 
                            style="width: 100%; padding: 8px; background: #666; color: white; border: none; border-radius: 6px; margin-top: 8px; cursor: pointer;">
                        ‚Üê Back
                    </button>
                </div>
            `;
        }

        async function calculateEngageEJV(storeId, storeName, baseEjv) {
            const mentoring_hours = parseFloat(document.getElementById('mentoring_hours').value) || 0;
            const volunteering_hours = parseFloat(document.getElementById('volunteering_hours').value) || 0;
            const verified = document.getElementById('verified').checked;
            
            try {
                const response = await fetch(`/api/ejv-v4.2/${storeId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        zip: currentZip,
                        location: storeName,
                        purchase: 100,
                        participation: {
                            mentoring: {
                                hours: mentoring_hours,
                                verified: verified,
                                duration_months: 12
                            },
                            volunteering: {
                                hours: volunteering_hours,
                                verified: verified,
                                duration_months: 6
                            }
                        }
                    })
                });
                
                const data = await response.json();
                displayEngageResults(storeName, data, baseEjv);
            } catch (error) {
                showResult(`Error calculating EJV v4.2: ${error.message}`);
            }
        }

        function displayEngageResults(storeName, data, baseEjv) {
            const storeListDiv = document.getElementById('storeList');
            const ejv42 = data.ejv_v42;
            const paf = data.participation.paf;
            const amplification = ejv42.amplification_value;
            
            storeListDiv.innerHTML = `
                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px; color: #ff5722;">
                    ü§ù ${storeName} - EJV v4.2 Results
                </div>
                
                <div style="background: linear-gradient(135deg, #ff5722 0%, #ff9800 100%); padding: 15px; border-radius: 8px; margin-bottom: 12px; color: white;">
                    <div style="font-size: 20px; font-weight: 700; margin-bottom: 5px;">
                        $${ejv42.elvr_amplified.toFixed(2)}
                    </div>
                    <div style="font-size: 11px; opacity: 0.9;">Amplified Local Value Retained (ELVR)</div>
                </div>
                
                <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                    <div style="font-size: 11px; line-height: 1.8;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: #666;">Base ELVR (v4.1):</span>
                            <span style="font-weight: 600;">$${ejv42.elvr_base.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: #666;">PAF Multiplier:</span>
                            <span style="font-weight: 600; color: #ff5722;">${paf.toFixed(3)}x</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding-top: 5px; border-top: 1px solid #eee;">
                            <span style="color: #ff5722; font-weight: 600;">Amplification:</span>
                            <span style="font-weight: 600; color: #ff5722;">+$${amplification.toFixed(2)} (+${((paf - 1) * 100).toFixed(1)}%)</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f5f5f5; padding: 10px; border-radius: 6px; font-size: 10px; color: #666; line-height: 1.6; margin-bottom: 12px;">
                    <strong>Interpretation:</strong><br>
                    ${data.interpretation.message}
                </div>
                
                <button onclick="showEngageMode()" 
                        style="width: 100%; padding: 10px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    ‚Üê Back to Engage Mode
                </button>
            `;
        }

        // Logout function - just reload the page (no login required)
        function handleLogout() {
            console.log('Refreshing application...');
            window.location.reload();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('========================================');
            console.log('FIX$ GeoEquity Impact Engine - Initializing');
            console.log('========================================');
            console.log('‚úì Page loaded');
            
            // Update user display
            if (currentUser && currentUser.username) {
                document.getElementById('userDisplay').textContent = `üë§ ${currentUser.username}`;
                console.log('‚úì User display updated:', currentUser.username);
            }
            
            console.log('‚úì Initializing map...');
            initMap();
        });

        function initMap() {
            if (map) {
                console.log('Removing existing map');
                map.remove();
            }
            
            console.log('Initializing map...');
            const mapContainer = document.getElementById('map');
            console.log('Map container:', mapContainer);
            console.log('Map container dimensions:', mapContainer?.offsetWidth, 'x', mapContainer?.offsetHeight);
            
            if (!mapContainer) {
                console.error('Map container not found!');
                return;
            }
            
            map = L.map('map').setView([39.8283, -98.5795], 4);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            setTimeout(() => {
                map.invalidateSize();
                console.log('Map initialized successfully');
            }, 200);
        }

        function toggleCustomSearch(type) {
            const select = document.getElementById(type + 'Category');
            const customDiv = document.getElementById(type + 'CustomSearch');
            
            if (select.value === 'custom') {
                customDiv.style.display = 'block';
            } else {
                customDiv.style.display = 'none';
            }
        }

        async function searchByZip() {
            const zip = document.getElementById('zipInput').value.trim();
            const radius = document.getElementById('zipRadius').value;
            let category = document.getElementById('zipCategory').value;
            
            // Save current ZIP for EJV calculations
            if (zip) {
                currentZip = zip;
            }
            
            // Check if custom search
            if (category === 'custom') {
                const customValue = document.getElementById('zipCustomInput').value.trim();
                if (!customValue) {
                    showResult('Please enter a business type');
                    return;
                }
                category = customValue;
            }

            if (!zip) {
                showResult('Please enter a ZIP code');
                return;
            }

            showLoading(true);
            showResult('Geocoding ZIP code...');

            try {
                // Geocode ZIP code using Nominatim
                const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&postalcode=${zip}&country=USA`;
                const geocodeResponse = await fetch(geocodeUrl);
                const geocodeData = await geocodeResponse.json();

                if (geocodeData.length === 0) {
                    showResult('ZIP code not found');
                    showLoading(false);
                    return;
                }

                const lat = parseFloat(geocodeData[0].lat);
                const lon = parseFloat(geocodeData[0].lon);

                map.setView([lat, lon], 13);

                await searchStores(lat, lon, radius * 1609.34, category);

            } catch (error) {
                console.error('Error:', error);
                showResult('Error searching stores: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function searchByAddress() {
            const address = document.getElementById('addressInput').value.trim();
            const radius = document.getElementById('addressRadius').value;
            let category = document.getElementById('addressCategory').value;
            
            // Check if custom search
            if (category === 'custom') {
                const customValue = document.getElementById('addressCustomInput').value.trim();
                if (!customValue) {
                    showResult('Please enter a business type');
                    return;
                }
                category = customValue;
            }

            if (!address) {
                showResult('Please enter an address');
                return;
            }

            showLoading(true);
            showResult('Geocoding address...');

            try {
                // Geocode address using Nominatim
                const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
                const geocodeResponse = await fetch(geocodeUrl);
                const geocodeData = await geocodeResponse.json();

                if (geocodeData.length === 0) {
                    showResult('Address not found');
                    showLoading(false);
                    return;
                }

                const lat = parseFloat(geocodeData[0].lat);
                const lon = parseFloat(geocodeData[0].lon);

                map.setView([lat, lon], 13);

                await searchStores(lat, lon, radius * 1609.34, category);

            } catch (error) {
                console.error('Error:', error);
                showResult('Error searching stores: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function searchStores(lat, lon, radiusMeters, category) {
            clearMarkers();
            showResult('Searching for stores...');

            try {
                // Build Overpass query based on category
                let query;
                if (category === 'all') {
                    query = `[out:json][timeout:15];
(
  node["shop"](around:${radiusMeters},${lat},${lon});
  way["shop"](around:${radiusMeters},${lat},${lon});
  node["amenity"="restaurant"](around:${radiusMeters},${lat},${lon});
  way["amenity"="restaurant"](around:${radiusMeters},${lat},${lon});
);
out center;`;

                } else if (category === 'restaurant') {
                    // Restaurants use amenity tag, not shop tag
                    query = `[out:json][timeout:30];
(
  node["amenity"="restaurant"](around:${radiusMeters},${lat},${lon});
  way["amenity"="restaurant"](around:${radiusMeters},${lat},${lon});
  node["amenity"="fast_food"](around:${radiusMeters},${lat},${lon});
  way["amenity"="fast_food"](around:${radiusMeters},${lat},${lon});
);
out center;`;
                } else if (category === 'pharmacy') {
                    // Pharmacies use amenity tag in OSM
                    query = `[out:json][timeout:30];
(
  node["amenity"="pharmacy"](around:${radiusMeters},${lat},${lon});
  way["amenity"="pharmacy"](around:${radiusMeters},${lat},${lon});
);
out center;`;
                } else if (category === 'coffee') {
                    // Coffee shops use amenity=cafe in OSM
                    query = `[out:json][timeout:30];
(
  node["amenity"="cafe"](around:${radiusMeters},${lat},${lon});
  way["amenity"="cafe"](around:${radiusMeters},${lat},${lon});
  node["shop"="coffee"](around:${radiusMeters},${lat},${lon});
  way["shop"="coffee"](around:${radiusMeters},${lat},${lon});
);
out center;`;
                } else {
                    const categoryMap = {
                        'supermarket': 'supermarket',
                        'convenience': 'convenience',
                        'electronics': 'electronics'
                    };
                    const shopValue = categoryMap[category] || category; // Use direct value if not in map
                    // Only search shop tag for these categories (not amenity) to prevent wrong results
                    query = `[out:json][timeout:30];
(
  node["shop"="${shopValue}"](around:${radiusMeters},${lat},${lon});
  way["shop"="${shopValue}"](around:${radiusMeters},${lat},${lon});
);
out center;`;
                }

                console.log('Sending query to backend proxy...');
                console.log('Query:', query.substring(0, 100) + '...');
                showResult('Searching for stores...');
                
                // Use our backend proxy instead of calling Overpass directly
                const response = await fetch('/api/overpass', {
                    method: 'POST',
                    body: query
                });

                console.log('Proxy response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    console.error('Backend error response:', errorData);
                    
                    const errorMsg = errorData.error || `Server returned ${response.status}`;
                    const details = errorData.details ? `\n${errorData.details}` : '';
                    
                    throw new Error(errorMsg + details);
                }

                const data = await response.json();
                console.log('Backend response data:', data);
                
                if (data.error) {
                    console.error('Overpass error:', data.error);
                    const fullError = data.details ? `${data.error}\nDetails: ${data.details}` : data.error;
                    throw new Error(fullError);
                }
                
                console.log('‚úì Got response:', data.elements?.length || 0, 'elements');
                const stores = data.elements;

                if (!stores || stores.length === 0) {
                    showResult('No stores found in this area. Try: (1) Larger radius, (2) Different category, or (3) Different location.');
                    document.getElementById('storeList').innerHTML = '<div style="padding: 10px; color: #666; font-size: 12px;">üí° Tip: Some areas have limited data. Try searching in major cities or use "All Stores" category.</div>';
                    console.warn('No stores returned from Overpass API');
                    return;
                }

                console.log(`Found ${stores.length} stores, calling displayStores`);
                console.log('Sample store data:', stores[0]);
                showResult(`Found ${stores.length} store(s)`);
                displayStores(stores);
                console.log(`Markers on map: ${markers.length}`);

            } catch (error) {
                console.error('Error:', error);
                const errorMessage = error.message || 'Unknown error occurred';
                
                // Detect 503 errors specifically
                const is503Error = errorMessage.includes('503') || errorMessage.includes('unavailable') || errorMessage.includes('Service unavailable');
                
                // Show user-friendly error with retry button
                showResult(`‚ùå ${errorMessage}`);
                
                // Add retry button to store list with specific guidance for 503
                const storeListDiv = document.getElementById('storeList');
                const bgColor = is503Error ? '#ffe6e6' : '#fff3cd';
                const borderColor = is503Error ? '#dc3545' : '#ffc107';
                const textColor = is503Error ? '#721c24' : '#856404';
                
                storeListDiv.innerHTML = `
                    <div style="padding: 15px; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 6px; margin: 10px 0;">
                        <div style="font-size: 13px; color: ${textColor}; margin-bottom: 10px;">
                            <strong>${is503Error ? 'üî¥ Server Overload (503)' : '‚ö†Ô∏è Search Failed'}</strong><br>
                            ${errorMessage.replace(/\n/g, '<br>')}
                        </div>
                        <div style="font-size: 12px; color: ${textColor}; margin-bottom: 10px;">
                            <strong>${is503Error ? 'Quick Fixes:' : 'Suggestions:'}</strong><br>
                            ${is503Error ? 
                                '‚Ä¢ <strong>Reduce radius to 1 mile</strong> and retry immediately<br>‚Ä¢ Try a major city like New York, Los Angeles, Chicago<br>‚Ä¢ Wait 60 seconds if all servers are busy<br>‚Ä¢ Use "Grocery" or "Restaurant" categories (better data)' :
                                '‚Ä¢ Reduce search radius (try 1-2 miles)<br>‚Ä¢ Wait 30 seconds and try again<br>‚Ä¢ Try a different location or category<br>‚Ä¢ Search in major cities for better results'}
                        </div>
                        <button onclick="location.reload()" 
                                style="background: ${borderColor}; color: ${is503Error ? '#fff' : '#000'}; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: 600;">
                            üîÑ Refresh & Retry
                        </button>
                    </div>
                `;
            }
        }
        function displayStores(stores) {
            const storeListDiv = document.getElementById('storeList');
            storeListDiv.innerHTML = '';
            storeData = [];
            rawStores = stores; // Save for re-rendering

            console.log(`Displaying ${stores.length} stores on map`);
            console.log('Map object:', map);
            console.log('Leaflet loaded:', typeof L !== 'undefined');

            if (!map) {
                console.error('Map is not initialized!');
                showResult('Error: Map not initialized');
                return;
            }

            stores.forEach((store, index) => {
                const lat = store.lat || store.center?.lat;
                const lon = store.lon || store.center?.lon;

                if (!lat || !lon) {
                    console.log('Skipping store - no coordinates:', store);
                    return;
                }

                const storeName = store.tags?.name || store.tags?.shop || store.tags?.amenity || 'Unnamed Store';
                let shopType = store.tags?.shop || store.tags?.amenity || 'default';
                
                // Detect warehouse clubs
                if (shopType === 'wholesale' || /costco|sam's club|bj's wholesale/i.test(storeName)) {
                    shopType = 'warehouse';
                }
                // Normalize restaurant types
                if (shopType === 'fast_food' || shopType === 'restaurant') {
                    shopType = 'restaurant';
                }
                
                const storeIcon = getStoreIcon(shopType);
                console.log(`Creating marker for ${storeName} (type: ${shopType}) with icon ${storeIcon.icon}`);
                
                const address = [
                    store.tags?.['addr:housenumber'],
                    store.tags?.['addr:street'],
                    store.tags?.['addr:city']
                ].filter(Boolean).join(' ');

                // Store data for dashboard
                storeData.push({
                    id: store.id,
                    name: storeName,
                    type: shopType,
                    lat: lat,
                    lon: lon
                });

                // Create custom marker with icon
                const customIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="font-size: 36px; text-shadow: 2px 2px 6px rgba(0,0,0,0.5), 0 0 10px rgba(255,255,255,0.3);">${storeIcon.icon}</div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 40]
                });

                console.log(`Adding marker at [${lat}, ${lon}]`);

                try {
                    const marker = L.marker([lat, lon], { icon: customIcon }).addTo(map);
                    markers.push(marker);
                    console.log(`Marker added successfully, total markers: ${markers.length}`);
                    
                    // Store reference for impact circle
                    marker.storeId = store.id;
                    marker.storeName = storeName;
                    
                    // Auto-calculate on hover with minimal debouncing (cached responses are instant)
                    marker.on('mouseover', async function(e) {
                        clearTimeout(hoverDebounceTimer);
                        hoverDebounceTimer = setTimeout(async () => {
                            console.log(`Map marker hover: ${storeName}, showing EJV on dashboard`);
                            const ejvData = await calculateEJV(store.id, storeName, true);
                            if (ejvData) {
                                showImpactCircle(e.latlng, ejvData.elvr || 0);
                            }
                        }, 50); // 50ms debounce - instant for cached data
                    });
                    
                    marker.on('mouseout', function() {
                        clearTimeout(hoverDebounceTimer);
                        hideImpactCircle();
                    });
                    
                    const popupContent = `
                        <div style="min-width: 220px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <span style="font-size: 28px;">${storeIcon.icon}</span>
                                <strong style="flex: 1; font-size: 14px;">${storeName}</strong>
                            </div>
                            ${address ? `<div style="font-size: 12px; color: #666; margin-bottom: 8px;">üìç ${address}</div>` : ''}
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 5px; margin-bottom: 10px;">
                                <small style="color: #666;">Category: <strong style="color: ${storeIcon.color};">${shopType}</strong></small>
                            </div>
                            <div style="text-align: center; color: #667eea; font-size: 11px; font-style: italic;">Hover to see EJV scores on dashboard ‚Üí</div>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                } catch (markerError) {
                    console.error('Error creating marker:', markerError);
                }

                // Create store list item with LOCATOR UI pattern
                const storeItem = document.createElement('div');
                storeItem.className = `store-item ${shopType}`;
                storeItem.style.transition = 'all 0.2s ease';
                storeItem.style.position = 'relative';
                storeItem.innerHTML = `
                    <div class="store-name" style="font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                        <span class="store-icon">${storeIcon.icon}</span>
                        <span>${storeName}</span>
                        <span style="color: #ffa500; font-size: 10px;">‚òÖ</span>
                    </div>
                    <div class="ejv-scores" style="margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 11px;">
                            <span style="color: #666;">EJV v2 (Gov):</span>
                            <span id="ejv-v2-${store.id}" style="font-weight: 700; color: #7b1fa2;">...</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 11px;">
                            <span style="color: #666;">EJV v4.1 (Adv):</span>
                            <span id="ejv-v41-${store.id}" style="font-weight: 700; color: #1976d2;">...</span>
                        </div>
                    </div>
                    <div class="ejv-actions" style="display: flex; gap: 6px; margin-top: 8px;">
                        <button onclick="showWhyModal('${store.id}', '${storeName.replace(/'/g, "\\'")}')" style="flex: 1; padding: 4px 8px; background: #667eea; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: 600;">Why?</button>
                        <button onclick="compareStore('${store.id}')" style="flex: 1; padding: 4px 8px; background: #26a69a; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: 600;">Compare</button>
                    </div>
                `;
                
                storeItem.onmouseenter = async () => {
                    // Visual feedback
                    storeItem.style.backgroundColor = '#f0f4ff';
                    storeItem.style.borderLeftWidth = '4px';
                    storeItem.style.transform = 'translateX(2px)';
                    
                    clearTimeout(hoverDebounceTimer);
                    hoverDebounceTimer = setTimeout(async () => {
                        console.log(`Hovering on ${storeName}, loading EJV data`);
                        const ejvData = await calculateEJV(store.id, storeName, true);
                        if (ejvData && ejvData.data) {
                            // Update scores in the list item
                            const v2Element = document.getElementById(`ejv-v2-${store.id}`);
                            const v41Element = document.getElementById(`ejv-v41-${store.id}`);
                            if (v2Element && ejvData.data.ejv_v2_baseline?.EJV) {
                                v2Element.textContent = ejvData.data.ejv_v2_baseline.EJV.toFixed(1);
                            }
                            if (v41Element && ejvData.data.elvr) {
                                v41Element.textContent = '$' + ejvData.data.elvr.toFixed(2);
                            }
                            
                            // Show impact circle on map
                            const marker = markers.find(m => m.storeId === store.id);
                            if (marker) {
                                showImpactCircle(marker.getLatLng(), ejvData.elvr || 0);
                            }
                        }
                    }, 50); // 50ms debounce - instant for cached data
                };
                
                storeItem.onmouseleave = () => {
                    // Reset visual feedback
                    storeItem.style.backgroundColor = '';
                    storeItem.style.borderLeftWidth = '3px';
                    storeItem.style.transform = '';
                    
                    clearTimeout(hoverDebounceTimer);
                    hideImpactCircle();
                };
                storeItem.onclick = () => {
                    map.setView([lat, lon], 16);
                    marker.openPopup();
                };
                storeListDiv.appendChild(storeItem);
            });

            // Fit map to show all markers
            if (markers.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds(), { padding: [50, 50] });
                console.log(`Map fitted to ${markers.length} markers`);
            }
        }

        // LOCATOR UI Pattern action buttons
        async function showWhyModal(storeId, storeName) {
            const ejvData = await calculateEJV(storeId, storeName, false);
            if (!ejvData || !ejvData.data) return;
            
            const data = ejvData.data;
            const lc = data.local_capture_components || {};
            
            const modalContent = `
                <div style="padding: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìä ${storeName} - Local Capture Breakdown</h3>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 18px; font-weight: 700; color: #1976d2; margin-bottom: 5px;">
                            ELVR: $${(data.elvr || 0).toFixed(2)}
                        </div>
                        <div style="font-size: 12px; color: #666;">Estimated Local Value Retained (per $100 spent)</div>
                    </div>
                    
                    <h4 style="margin: 15px 0 10px; color: #333;">5-Flow Decomposition:</h4>
                    <div style="font-size: 12px; line-height: 2;">
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: #f0f4ff; border-radius: 4px; margin-bottom: 5px;">
                            <span>üíº Wages (35%):</span>
                            <strong style="color: #1976d2;">$${((lc.wages || 0) * 100).toFixed(2)}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: #fff; border-radius: 4px; margin-bottom: 5px;">
                            <span>üè™ Suppliers (25%):</span>
                            <strong style="color: #1976d2;">$${((lc.suppliers || 0) * 100).toFixed(2)}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: #f0f4ff; border-radius: 4px; margin-bottom: 5px;">
                            <span>üèõÔ∏è Taxes (15%):</span>
                            <strong style="color: #1976d2;">$${((lc.taxes || 0) * 100).toFixed(2)}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: #fff; border-radius: 4px; margin-bottom: 5px;">
                            <span>üí∞ Financing (15%):</span>
                            <strong style="color: #1976d2;">$${((lc.financing || 0) * 100).toFixed(2)}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: #f0f4ff; border-radius: 4px;">
                            <span>üë• Ownership (10%):</span>
                            <strong style="color: #1976d2;">$${((lc.ownership || 0) * 100).toFixed(2)}</strong>
                        </div>
                    </div>
                    
                    <h4 style="margin: 15px 0 10px; color: #333;">Data Provenance:</h4>
                    <div style="font-size: 11px; color: #666; line-height: 1.6; background: #fffef0; padding: 10px; border-radius: 4px;">
                        <strong>EJV v2 Baseline:</strong> Census/ACS, BLS, TIGER (government open data)<br>
                        <strong>EJV v4.1 Flows:</strong> Business profiles, local supplier networks, ownership structure<br>
                        <strong>Verification:</strong> OpenStreetMap + local data sources
                    </div>
                    
                    <button onclick="closeModal()" style="width: 100%; margin-top: 15px; padding: 10px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Close</button>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        function compareStore(storeId) {
            // Switch to compare mode to see all stores
            setDecisionMode('compare');
        }
        
        function engageStore(storeId) {
            // Switch to ENGAGE mode
            decisionMode = 'engage';
            showEngageMode();
            alert('Switched to ENGAGE mode - EJV v4.2 with Participation Amplification is now active');
        }
        
        function showModal(content) {
            const modal = document.createElement('div');
            modal.id = 'customModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `<div style="background: white; border-radius: 10px; max-width: 600px; max-height: 80vh; overflow-y: auto;">${content}</div>`;
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) closeModal(); };
        }
        
        function closeModal() {
            const modal = document.getElementById('customModal');
            if (modal) modal.remove();
        }

        async function calculateEJV(storeId, storeName, showDashboard = false) {
            // Check cache first for instant response
            if (ejvCache[storeId]) {
                console.log(`Using cached EJV for ${storeName}`);
                if (showDashboard) {
                    updateRightDashboard(ejvCache[storeId].data, storeName);
                }
                return ejvCache[storeId];
            }
            
            console.log(`Calculating EJV for store ${storeId} (${storeName})`);
            try {
                // Call backend API with store ID (v4.1 for decomposed flows)
                const apiUrl = `/api/ejv-v4.1/${storeId}?zip=${currentZip}`;
                console.log('Calling API:', apiUrl);
                const response = await fetch(apiUrl);
                console.log('API Response status:', response.status, response.ok);
                
                // If API fails, use mock data for demo
                let data;
                if (!response.ok) {
                    console.warn('API failed, using mock data');
                    data = {
                        ejv_version: "4.1",
                        elvr: 75.5 + Math.random() * 15,
                        evl: 20 + Math.random() * 10,
                        retention_percentage: 75 + Math.random() * 10,
                        local_capture_components: {
                            lc_wages: 0.75,
                            lc_suppliers: 0.65,
                            lc_taxes: 0.75,
                            lc_financing: 0.70,
                            lc_ownership: 0.85,
                            lc_aggregate: 0.74
                        },
                        ejv_v2_baseline: {
                            EJV: 75 + Math.random() * 20,
                            justice_score_zip: 70 + Math.random() * 20,
                            wage_score: 70 + Math.random() * 20,
                            hiring_score: 75 + Math.random() * 20,
                            community_score: 80 + Math.random() * 15,
                            participation_score: 72 + Math.random() * 20
                        },
                        dimensions: {
                            AES: 0.75 + Math.random() * 0.2,
                            ART: 0.70 + Math.random() * 0.2,
                            HWI: 0.80 + Math.random() * 0.15,
                            PSR: 0.72 + Math.random() * 0.2,
                            CAI: 0.78 + Math.random() * 0.15,
                            JCE: 0.73 + Math.random() * 0.2,
                            FSI: 0.76 + Math.random() * 0.15,
                            CED: 0.74 + Math.random() * 0.2,
                            ESD: 0.71 + Math.random() * 0.2
                        },
                        data_sources: {
                            wage: "BLS OEWS May 2024",
                            demographics: "Census ACS 2022"
                        }
                    };
                } else {
                    data = await response.json();
                }

                console.log('EJV API Response:', data);

                if (data.error) {
                    console.error('EJV Error:', data.error);
                    return null;
                }

                // Extract values from v4.1 API structure
                const elvr = data.elvr || 0;
                const evl = data.evl || 0;
                const ejvV2Baseline = data.ejv_v2_baseline?.EJV || 0;

                console.log(`EJV v4.1 - ELVR: $${elvr}, EVL: $${evl}, Retention: ${data.retention_percentage}%`);

                // Store in global array for compare/optimize modes
                const storeEJV = {
                    id: storeId,
                    storeId: storeId,
                    name: storeName,
                    type: data.store_type || 'default',
                    elvr: elvr,
                    evl: evl,
                    retention_percentage: data.retention_percentage || 0,
                    ejv_v2_baseline: ejvV2Baseline,
                    data: data,
                    lat: storeData.find(s => s.id === storeId)?.lat,
                    lon: storeData.find(s => s.id === storeId)?.lon
                };
                
                // Update or add to array
                const existingIndex = allStoresEJV.findIndex(s => s.id === storeId);
                if (existingIndex >= 0) {
                    allStoresEJV[existingIndex] = storeEJV;
                } else {
                    allStoresEJV.push(storeEJV);
                }

                // Cache the result for instant future access
                const result = { elvr: elvr, evl: evl, ejv_v2_baseline: ejvV2Baseline, data: data };
                ejvCache[storeId] = result;
                console.log(`Cached EJV for store ${storeId}`);
                
                // Show right dashboard if requested
                if (showDashboard) {
                    console.log('Updating dashboard with data');
                    updateRightDashboard(data, storeName);
                }

                return result;
            } catch (error) {
                console.error('Error calculating EJV:', error);
                return null;
            }
        }

        // Impact Grid Visualization with Colored Squares
        let currentImpactCircle = null;
        let impactCircleLayers = [];

        function showImpactCircle(latlng, ejvScore) {
            console.log(`Showing impact grid at ${latlng.lat}, ${latlng.lng} with EJV score ${ejvScore}`);
            hideImpactCircle();
            
            // Determine impact level and color
            const color = ejvScore >= 70 ? '#28a745' : ejvScore >= 40 ? '#ffc107' : '#dc3545';
            
            // Create a grid of colored squares around the store
            // Grid size: 3x3 for better performance (was 5x5)
            const gridSize = 3;
            const squareSize = 0.0012; // Larger squares to maintain visual impact
            
            // Calculate starting position (center the grid on the store)
            const centerOffset = Math.floor(gridSize / 2);
            
            for (let row = 0; row < gridSize; row++) {
                for (let col = 0; col < gridSize; col++) {
                    // Calculate position offset from center
                    const rowOffset = (row - centerOffset) * squareSize;
                    const colOffset = (col - centerOffset) * squareSize;
                    
                    // Calculate square position
                    const squareLat = latlng.lat + rowOffset;
                    const squareLng = latlng.lng + colOffset;
                    
                    // Calculate distance from center (for gradient effect)
                    const distanceFromCenter = Math.sqrt(Math.pow(row - centerOffset, 2) + Math.pow(col - centerOffset, 2));
                    const maxDistance = Math.sqrt(2 * Math.pow(centerOffset, 2));
                    
                    // Opacity decreases with distance from center
                    let opacity = 0.6 - (distanceFromCenter / maxDistance) * 0.4;
                    
                    // Add some variation to create a more organic pattern
                    const variation = (Math.random() * 0.15) - 0.075;
                    opacity = Math.max(0.2, Math.min(0.7, opacity + variation));
                    
                    // Slightly vary the color intensity for each square
                    let squareColor = color;
                    const brightnessVariation = Math.random() * 0.2 - 0.1;
                    
                    // Create rectangle bounds for the square
                    const bounds = [
                        [squareLat - squareSize/2, squareLng - squareSize/2],
                        [squareLat + squareSize/2, squareLng + squareSize/2]
                    ];
                    
                    // Create the square
                    const square = L.rectangle(bounds, {
                        fillColor: squareColor,
                        fillOpacity: opacity,
                        color: squareColor,
                        weight: 1,
                        opacity: opacity * 0.8
                    }).addTo(map);
                    
                    impactCircleLayers.push(square);
                }
            }
            
            // Add a brighter center square to mark the store location
            const centerBounds = [
                [latlng.lat - squareSize/2, latlng.lng - squareSize/2],
                [latlng.lat + squareSize/2, latlng.lng + squareSize/2]
            ];
            
            const centerSquare = L.rectangle(centerBounds, {
                fillColor: color,
                fillOpacity: 0.8,
                color: '#ffffff',
                weight: 2,
                opacity: 1
            }).addTo(map);
            
            impactCircleLayers.push(centerSquare);
            
            console.log(`Impact grid created with ${impactCircleLayers.length} squares`);
        }

        function hideImpactCircle() {
            impactCircleLayers.forEach(layer => {
                if (map.hasLayer(layer)) {
                    map.removeLayer(layer);
                }
            });
            impactCircleLayers = [];
            currentImpactCircle = null;
        }

        function updateRightDashboard(data, storeName) {
            const dashboard = document.getElementById('rightDashboard');
            
            // Show dashboard with smooth animation
            if (dashboard.style.display === 'none' || !dashboard.style.display) {
                dashboard.style.display = 'block';
                dashboard.style.opacity = '0';
                setTimeout(() => {
                    dashboard.style.transition = 'opacity 0.3s ease';
                    dashboard.style.opacity = '1';
                }, 10);
            }
            
            console.log(`Updating dashboard for ${storeName}`);
            console.log('API Data received - elvr:', data.elvr, 'ejv_v2:', data.ejv_v2_baseline?.EJV);
            
            // Store info
            document.getElementById('storeNameDisplay').textContent = storeName;
            document.getElementById('storeLocationDisplay').textContent = data.location || data.zip_code || 'Unknown';
            
            // Extract values from v4.1 structure
            const elvr = data.elvr || 0;
            const evl = data.evl || 0;
            const retentionPct = data.retention_percentage || 0;
            const ejvV2Baseline = data.ejv_v2_baseline?.EJV || 0;
            const wealthRetained = elvr;  // ELVR from v4.1
            const wealthLeakage = evl;    // EVL from v4.1
            
            // EJV v4.2 with constant PAF demonstrating all 5 participation pathways
            // PAF is the same for all stores because participation is a choice any business can make,
            // regardless of size or revenue. In production, each business reports actual participation.
            // Updated: 2026-01-22 v4 - All 5 pathways for maximum demonstration
            
            // Demo participation: comprehensive engagement across all 5 pathways
            const demoParticipation = {
                mentoring: { hours: 3, verified: true, duration_months: 12 },
                volunteering: { hours: 2, verified: true, duration_months: 12 },
                sponsorship: { hours: 1, verified: true, duration_months: 12 },
                apprenticeship: { hours: 2, verified: true, duration_months: 10 },
                facilities: { hours: 1, verified: false, duration_months: 12 }
            };
            
            const paf = calculatePAF(demoParticipation); // Returns ~1.232 (close to max 1.25)
            console.log(`Store: ${storeName}, ELVR v4.1: $${elvr.toFixed(2)}, PAF: ${paf} (all 5 pathways)`);
            const ejvV42 = elvr * paf;  // Apply PAF to v4.1 ELVR
            const ampValue = ejvV42 - elvr;
            
            // Calculate percentages for wealth flows
            const totalWealth = wealthRetained + wealthLeakage;
            const retainedPercent = totalWealth > 0 ? (wealthRetained / totalWealth) * 100 : 0;
            const leakagePercent = totalWealth > 0 ? (wealthLeakage / totalWealth) * 100 : 0;
            
            // Determine impact category based on v2 baseline score and styling
            let impactCategory, impactColor, impactBg, impactBorder, impactLabel;
            if (ejvV2Baseline >= 75) {
                impactCategory = 'Excellent';
                impactLabel = 'üåü Outstanding';
                impactColor = '#1b5e20';
                impactBg = 'linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%)';
                impactBorder = '#4caf50';
            } else if (ejvV2Baseline >= 50) {
                impactCategory = 'Good';
                impactLabel = 'üëç Good';
                impactColor = '#01579b';
                impactBg = 'linear-gradient(135deg, #b3e5fc 0%, #81d4fa 100%)';
                impactBorder = '#03a9f4';
            } else if (ejvV2Baseline >= 25) {
                impactCategory = 'Fair';
                impactLabel = '‚ö†Ô∏è Moderate';
                impactColor = '#e65100';
                impactBg = 'linear-gradient(135deg, #ffe0b2 0%, #ffcc80 100%)';
                impactBorder = '#ff9800';
            } else {
                impactCategory = 'Poor';
                impactLabel = '‚ö° Limited';
                impactColor = '#b71c1c';
                impactBg = 'linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%)';
                impactBorder = '#f44336';
            }

            // Main EJV scores
            console.log('About to set displays - ejvV2Baseline:', ejvV2Baseline, 'elvr:', elvr);
            
            const v2Display = document.getElementById('ejvV2Display');
            const v41Display = document.getElementById('ejvV41Display');
            
            if (v2Display) {
                const v2Value = ejvV2Baseline > 0 ? ejvV2Baseline.toFixed(2) : '0.00';
                v2Display.textContent = v2Value;
                v2Display.parentElement.style.background = impactBg;
                v2Display.parentElement.style.borderColor = impactBorder;
                v2Display.style.color = impactColor;
                console.log('Set ejvV2Display to:', v2Value);
            }
            
            if (v41Display) {
                const v41Value = elvr > 0 ? '$' + elvr.toFixed(2) : '$0.00';
                v41Display.textContent = v41Value;
                console.log('Set ejvV41Display to:', v41Value);
            }
            
            console.log('Display values set - check screen');
            
            // v4.2 only shown in ENGAGE mode
            if (decisionMode === 'engage') {
                document.getElementById('ejvV42Display').textContent = '$' + ejvV42.toFixed(2);
                
                // Show participation panel
                const participationPanel = document.getElementById('participationPanel');
                participationPanel.style.display = 'block';
                document.getElementById('pafDisplay').textContent = paf.toFixed(3) + '√ó';
                document.getElementById('ampValueDisplay').textContent = '$' + ampValue.toFixed(2);
                
                // Show participation activities
                const activitiesHTML = `
                    <div style="margin-bottom: 4px;"><strong>Active Participation (5 Pathways):</strong></div>
                    <div style="margin-left: 10px;">‚Ä¢ 3 hrs/week <strong>mentoring</strong> (verified, 12mo)</div>
                    <div style="margin-left: 10px;">‚Ä¢ 2 hrs/week <strong>volunteering</strong> (verified, 12mo)</div>
                    <div style="margin-left: 10px;">‚Ä¢ 1 hr/week <strong>sponsorship</strong> (verified, 12mo)</div>
                    <div style="margin-left: 10px;">‚Ä¢ 2 hrs/week <strong>apprenticeship</strong> (verified, 10mo)</div>
                    <div style="margin-left: 10px;">‚Ä¢ 1 hr/week <strong>facilities</strong> support (12mo)</div>
                    <div style="margin-top: 6px; font-style: italic; color: #e65100;">Demo: ${((paf - 1) * 100).toFixed(1)}% amplification through comprehensive civic engagement</div>
                `;
                document.getElementById('participationActivities').innerHTML = activitiesHTML;
            } else {
                // Hide participation panel in other modes
                const participationPanel = document.getElementById('participationPanel');
                participationPanel.style.display = 'none';
            }

            // Wealth metrics as percentages
            document.getElementById('wealthRetained').textContent = retainedPercent.toFixed(1) + '%';
            document.getElementById('wealthLeakage').textContent = leakagePercent.toFixed(1) + '%';

            // Score breakdown - use v2 baseline
            document.getElementById('wageScore').textContent = (data.ejv_v2_baseline?.wage_score || data.wage_score || 0).toFixed(2);
            document.getElementById('hiringScore').textContent = (data.ejv_v2_baseline?.hiring_score || data.hiring_score || 0).toFixed(2);
            document.getElementById('communityScore').textContent = (data.ejv_v2_baseline?.community_score || data.community_score || 0).toFixed(2);
            document.getElementById('participationScore').textContent = (data.ejv_v2_baseline?.participation_score || data.participation_score || 0).toFixed(2);

            // 9 Dimensions - use v2 baseline
            const dims = data.ejv_v2_baseline?.dimensions || data.zip_analysis?.dimensions || data.adjusted_dimensions || data.dimensions;
            const dimensionsList = document.getElementById('dimensionsList');
            
            if (dims) {
                const dimensionNames = {
                    'AES': 'Access to Essential Services',
                    'ART': 'Access to Resources & Technology',
                    'HWI': 'Health, Wellness & Inclusion',
                    'PSR': 'Public Service Representation',
                    'CAI': 'Cultural Awareness & Inclusivity',
                    'JCE': 'Job Creation/Economic Empowerment',
                    'FSI': 'Financial Support & Investment',
                    'CED': 'Community Engagement & Development',
                    'ESD': 'Education & Skill Development'
                };

                let dimensionsHTML = '';
                for (const [key, name] of Object.entries(dimensionNames)) {
                    const value = dims[key];
                    if (value !== undefined) {
                        const percentage = value > 1 ? value : value * 100;
                        dimensionsHTML += `
                            <div style="display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 6px 10px; border-radius: 4px; font-size: 10px; border-left: 3px solid #667eea;">
                                <span style="color: #333; font-weight: 600;">${name}</span>
                                <span style="color: #667eea; font-weight: 700;">${percentage.toFixed(1)}%</span>
                            </div>
                        `;
                    }
                }
                dimensionsList.innerHTML = dimensionsHTML;
            }

            // Formula display
            const formulaText = document.getElementById('formulaText');
            const formula = data.ejv_v2?.formula || data.formula || data.calculation_formula;
            if (formula) {
                formulaText.textContent = formula;
            }

            // Data sources
            const dataSourcesList = document.getElementById('dataSourcesList');
            dataSourcesList.innerHTML = `
                <li>BLS OEWS May 2024 (wages)</li>
                <li>Census ACS 2022 (demographics)</li>
                <li>Unemployment: ${(data.zip_analysis?.unemployment_rate || 5.0).toFixed(1)}%</li>
                <li>Median Income: $${(data.zip_analysis?.median_income || 50000).toLocaleString()}</li>
                <li>Retention Rate: ${retentionPct.toFixed(1)}%</li>
                <li>ELVR: $${elvr.toFixed(2)}</li>
                <li>EVL: $${evl.toFixed(2)}</li>
            `;
        }

        function closeRightDashboard() {
            document.getElementById('rightDashboard').style.display = 'none';
        }

        function clearMarkers() {
            markers.forEach(marker => marker.remove());
            markers = [];
            hideImpactCircle();
            // Note: ejvCache is intentionally NOT cleared - keeps data for stores
            // users might return to, even after new searches
        }

        function showResult(message) {
            const resultText = document.getElementById('resultText');
            if (resultText) {
                resultText.textContent = message;
            }
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        // Handle Enter key in login form
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('password');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleLogin();
                    }
                });
            }
        });

        // Help Modal Functions
        async function showHelpModal(version) {
            const modal = document.getElementById('helpModal');
            let endpoint;
            if (version === 'v1') {
                endpoint = '/api/ejv-v1/help';
            } else if (version === 'v4.1') {
                endpoint = '/api/ejv-v4.1/help';
            } else if (version === 'v4.2') {
                endpoint = '/api/ejv-v4.2/help';
            } else {
                endpoint = '/api/ejv-v2/help';
            }
            
            try {
                const response = await fetch(endpoint);
                const helpData = await response.json();
                
                // Populate modal content
                document.getElementById('helpModalTitle').textContent = helpData.title;
                document.getElementById('helpModalSubtitle').textContent = helpData.subtitle;
                document.getElementById('helpModalDescription').textContent = helpData.description;
                
                // Formula section
                document.getElementById('helpFormula').innerHTML = `<code>${helpData.formula}</code>`;
                document.getElementById('helpFormulaExplanation').textContent = helpData.formula_explanation;
                
                // Components section
                let componentsHtml = '';
                if (version === 'v4.2') {
                    // For v4.2, show participation pathways and PAF
                    componentsHtml = `
                        <div class="help-component">
                            <h4>${helpData.core_innovation.name}</h4>
                            <p><strong>Description:</strong> ${helpData.core_innovation.description}</p>
                            <h5 style="margin-top: 15px; color: #ff9800;">Participation Pathways:</h5>
                            ${helpData.core_innovation.pathways.map(pathway => `
                                <div style="margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px;">
                                    <strong>${pathway.type}</strong> (${pathway.weight})
                                    <p>${pathway.description}</p>
                                    <p><em>Unit: ${pathway.unit}</em></p>
                                    <p><strong>Examples:</strong> ${pathway.examples.join(', ')}</p>
                                </div>
                            `).join('')}
                        </div>
                        <div class="help-component">
                            <h4>${helpData.paf.name}</h4>
                            <p><strong>Description:</strong> ${helpData.paf.description}</p>
                            <p><strong>Range:</strong> ${helpData.paf.range}</p>
                            <p><strong>Calculation Factors:</strong></p>
                            <ul>
                                ${helpData.paf.calculation_factors.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                            <h5 style="margin-top: 15px;">PAF Interpretation:</h5>
                            ${Object.entries(helpData.paf.interpretation).map(([value, meaning]) => `
                                <div style="padding: 5px 0;">
                                    <strong>${value}:</strong> ${meaning}
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else if (helpData.components) {
                    componentsHtml = helpData.components.map(comp => `
                        <div class="help-component">
                            <h4>${comp.name}</h4>
                            <p><strong>Description:</strong> ${comp.description}</p>
                            ${comp.calculation ? `<p><strong>Calculation:</strong> <code>${comp.calculation}</code></p>` : ''}
                            ${comp.factors ? `
                                <p><strong>Factors:</strong></p>
                                <ul>
                                    ${comp.factors.map(f => `<li>${f}</li>`).join('')}
                                </ul>
                            ` : ''}
                            ${comp.range ? `<p><strong>Range:</strong> ${comp.range}</p>` : ''}
                            ${comp.default ? `<p><strong>Default:</strong> ${comp.default}</p>` : ''}
                            ${comp.usage ? `<p><strong>Usage:</strong> ${comp.usage}</p>` : ''}
                        </div>
                    `).join('');
                }
                document.getElementById('helpComponents').innerHTML = componentsHtml;
                
                // Outputs section (for v4.1)
                let outputsHtml = '';
                if (version === 'v4.1' && helpData.outputs) {
                    outputsHtml = `
                        <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid #2196f3;">
                            <h4 style="color: #1976d2; margin-bottom: 10px;">üìä v4.1 Outputs</h4>
                            ${helpData.outputs.map(output => `
                                <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px;">
                                    <strong>${output.name}</strong>
                                    <p>${output.description}</p>
                                    <p><em>Calculation:</em> <code>${output.calculation}</code></p>
                                    <p><em>Display:</em> ${output.display}</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                componentsHtml += outputsHtml;
                
                // UI Pattern section (for v4.1)
                if (version === 'v4.1' && helpData.ui_pattern) {
                    const uiPatternHtml = `
                        <div style="margin-top: 20px; padding: 15px; background: #f3e5f5; border-radius: 6px; border-left: 4px solid #9c27b0;">
                            <h4 style="color: #7b1fa2; margin-bottom: 10px;">üé® ${helpData.ui_pattern.recommended}</h4>
                            <p><strong>${helpData.ui_pattern.description}</strong></p>
                            
                            <div style="margin: 15px 0; padding: 12px; background: white; border-radius: 6px; font-family: monospace; font-size: 13px;">
                                <div style="font-weight: bold; margin-bottom: 8px;">${helpData.ui_pattern.example.store}</div>
                                <div style="margin-left: 15px; line-height: 1.8;">
                                    <div>‚Ä¢ EJV v2 (Gov): <strong>${helpData.ui_pattern.example.ejv_v2_value}</strong></div>
                                    <div>‚Ä¢ EJV v4.1 (Adv): <strong>${helpData.ui_pattern.example.ejv_v4_1_value}</strong></div>
                                    <div style="margin-top: 5px;">[Why?] [Compare] [Enable]</div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 4px;">
                                <p style="margin: 5px 0;"><strong>Why?</strong> ${helpData.ui_pattern.example.why_button}</p>
                                <p style="margin: 5px 0;"><strong>Compare:</strong> ${helpData.ui_pattern.example.compare_button}</p>
                                <p style="margin: 5px 0;"><strong>Enable:</strong> ${helpData.ui_pattern.example.enable_button}</p>
                            </div>
                            
                            <p style="margin-top: 10px; font-style: italic; color: #666;"><em>Toggle Behavior:</em> ${helpData.ui_pattern.toggle_behavior}</p>
                        </div>
                    `;
                    componentsHtml += uiPatternHtml;
                }
                
                document.getElementById('helpComponents').innerHTML = componentsHtml;
                
                // Data sources section
                const sourcesHtml = helpData.data_sources.map(source => `
                    <div class="help-data-source">
                        <strong>üìä ${source.source}</strong>
                        <p>${source.data}</p>
                        ${source.url ? `<a href="${source.url}" target="_blank">${source.url}</a>` : ''}
                    </div>
                `).join('');
                document.getElementById('helpDataSources').innerHTML = sourcesHtml;
                
                // Key insight
                document.getElementById('helpKeyInsight').textContent = helpData.key_insight;
                
                // Interpretation (only for v1)
                const interpretationSection = document.getElementById('helpInterpretationSection');
                if (helpData.interpretation && version === 'v1') {
                    interpretationSection.style.display = 'block';
                    const interpHtml = `
                        <div class="help-interpretation-item excellent">
                            <strong>${helpData.interpretation.excellent}</strong>
                        </div>
                        <div class="help-interpretation-item good">
                            <strong>${helpData.interpretation.good}</strong>
                        </div>
                        <div class="help-interpretation-item fair">
                            <strong>${helpData.interpretation.fair}</strong>
                        </div>
                        <div class="help-interpretation-item poor">
                            <strong>${helpData.interpretation.poor}</strong>
                        </div>
                    `;
                    document.getElementById('helpInterpretation').innerHTML = interpHtml;
                } else {
                    interpretationSection.style.display = 'none';
                }
                
                // Example calculation (for v2 and v4.2)
                const exampleSection = document.getElementById('helpExampleSection');
                if (version === 'v4.2' && helpData.example) {
                    exampleSection.style.display = 'block';
                    const example = helpData.example;
                    const exampleHtml = `
                        <div class="help-component">
                            <h4>Example: ${example.scenario}</h4>
                            <p><strong>Base EJV v4.1:</strong> ${example.base_ejv_v41}</p>
                            <p><strong>Participation Activities:</strong></p>
                            <ul>
                                ${example.participation.map(p => `<li>${p}</li>`).join('')}
                            </ul>
                            <p><strong>PAF Calculated:</strong> ${example.paf_calculated}</p>
                            <p><strong>EJV v4.2 Result:</strong> ${example.ejv_v42}</p>
                            <p style="background: #e8f5e9; padding: 10px; border-radius: 6px; margin-top: 10px;">
                                <strong>üí° ${example.interpretation}</strong>
                            </p>
                        </div>
                    `;
                    document.getElementById('helpExample').innerHTML = exampleHtml;
                } else if (helpData.example_calculation && version === 'v2') {
                    exampleSection.style.display = 'block';
                    const example = helpData.example_calculation;
                    const exampleHtml = `
                        <div class="help-component">
                            <h4>Example: ${example.scenario}</h4>
                            <p><strong>Purchase:</strong> ${example.purchase}</p>
                            <p><strong>Local Capture:</strong> ${example.local_capture}</p>
                            <p><strong>Base Dimensions:</strong> ${example.base_dimensions}</p>
                            <p><strong>Adjusted Dimensions:</strong> ${example.adjusted_dimensions}</p>
                            <p><strong>Justice Score:</strong> ${example.justice_score}</p>
                            <p><strong>EJV v2 Result:</strong> ${example.ejv_v2}</p>
                            <p style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-top: 10px;">
                                <strong>üí° ${example.interpretation}</strong>
                            </p>
                        </div>
                    `;
                    document.getElementById('helpExample').innerHTML = exampleHtml;
                } else {
                    exampleSection.style.display = 'none';
                }
                
                // Nine Dimensions (only for v2)
                const dimensionsSection = document.getElementById('helpNineDimensionsSection');
                if (helpData.nine_dimensions && version === 'v2') {
                    dimensionsSection.style.display = 'block';
                    
                    const dims = helpData.nine_dimensions;
                    const dimensionsHtml = `
                        <p><strong>${dims.description}</strong></p>
                        ${dims.dimensions.map((dim, idx) => `
                            <div class="help-component" style="border-left: 4px solid ${idx < 3 ? '#ff9800' : '#667eea'};">
                                <h4>${dim.code}: ${dim.name} ${idx < 3 ? '‚ö°' : ''}</h4>
                                <p><strong>Calculation:</strong> ${dim.calculation}</p>
                                <p><strong>Modifier:</strong> ${dim.modifier}</p>
                                <p><strong>Represents:</strong> ${dim.represents}</p>
                            </div>
                        `).join('')}
                        
                        <div class="help-component" style="background: #fff8e1; border-left: 4px solid #ff9800;">
                            <h4>‚ö° ZIP Need Modifiers (NM)</h4>
                            <p>${dims.zip_need_modifiers.description}</p>
                            <p><strong>Range:</strong> ${dims.zip_need_modifiers.range}</p>
                            <p><strong>Factors:</strong></p>
                            <ul>
                                ${dims.zip_need_modifiers.factors.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                            <p><strong>Examples:</strong></p>
                            <ul>
                                ${dims.zip_need_modifiers.examples.map(e => `<li>${e}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                    document.getElementById('helpNineDimensions').innerHTML = dimensionsHtml;
                } else {
                    dimensionsSection.style.display = 'none';
                }
                
                // Advantages (only for v2)
                const advantagesSection = document.getElementById('helpAdvantagesSection');
                if (helpData.advantages && version === 'v2') {
                    advantagesSection.style.display = 'block';
                    const advantagesHtml = `
                        <ul>
                            ${helpData.advantages.map(adv => `<li>${adv}</li>`).join('')}
                        </ul>
                    `;
                    document.getElementById('helpAdvantages').innerHTML = advantagesHtml;
                } else {
                    advantagesSection.style.display = 'none';
                }
                
                // Show modal
                modal.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading help content:', error);
                alert('Failed to load help content. Please try again.');
            }
        }

        function closeHelpModal() {
            document.getElementById('helpModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('helpModal');
            if (event.target === modal) {
                closeHelpModal();
            }
        }
    </script>

    <!-- Help Modal -->
    <div id="helpModal" class="help-modal">
        <div class="help-modal-content">
            <div class="help-modal-header">
                <span class="help-close" onclick="closeHelpModal()">&times;</span>
                <h2 id="helpModalTitle">EJV Help</h2>
                <p id="helpModalSubtitle"></p>
            </div>
            <div class="help-modal-body">
                <div class="help-section">
                    <p id="helpModalDescription"></p>
                </div>
                
                <div class="help-insight" id="helpKeyInsight"></div>
                
                <div class="help-section">
                    <h3>üìê Formula</h3>
                    <div class="help-formula">
                        <div id="helpFormula"></div>
                        <p id="helpFormulaExplanation"></p>
                    </div>
                </div>
                
                <div class="help-section">
                    <h3>üî¢ Components</h3>
                    <div id="helpComponents"></div>
                </div>
                
                <div class="help-section" id="helpExampleSection" style="display: none;">
                    <h3>üí° Example Calculation</h3>
                    <div id="helpExample"></div>
                </div>
                
                <div class="help-section" id="helpNineDimensionsSection" style="display: none;">
                    <h3>üåü 9 Justice Dimensions</h3>
                    <div id="helpNineDimensions"></div>
                </div>
                
                <div class="help-section" id="helpAdvantagesSection" style="display: none;">
                    <h3>‚ú® Key Advantages</h3>
                    <div id="helpAdvantages"></div>
                </div>
                
                <div class="help-section" id="helpInterpretationSection" style="display: none;">
                    <h3>üìä Score Interpretation</h3>
                    <div class="help-interpretation" id="helpInterpretation"></div>
                </div>
                
                <div class="help-section">
                    <h3>üìä Data Sources</h3>
                    <div id="helpDataSources"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
