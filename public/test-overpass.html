<!DOCTYPE html>
<html>
<head>
    <title>Overpass API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .test-section {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            background: white;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>ðŸ”§ Overpass API Diagnostic Tool</h1>
    <p>This tool will help diagnose Overpass API issues.</p>

    <div class="test-section">
        <h3>Test 1: Check Server Availability</h3>
        <button onclick="testServers()">Test All Servers</button>
        <div id="serverResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>Test 2: Simple Query Test</h3>
        <p>Try a very simple query to get one node</p>
        <button onclick="testSimpleQuery()">Run Simple Query</button>
        <div id="simpleResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>Test 3: Real Store Search</h3>
        <p>Search for supermarkets in Manhattan (10001)</p>
        <button onclick="testRealSearch()">Search Stores</button>
        <div id="realResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>Test 4: Custom Query</h3>
        <label>Latitude: <input type="text" id="lat" value="40.7128" /></label>
        <label>Longitude: <input type="text" id="lon" value="-74.0060" /></label>
        <label>Radius (meters): <input type="text" id="radius" value="5000" /></label>
        <label>Category: <input type="text" id="category" value="supermarket" /></label>
        <button onclick="testCustomQuery()">Run Custom Query</button>
        <div id="customResult" class="result"></div>
    </div>

    <script>
        const servers = [
            'https://overpass-api.de/api/interpreter',
            'https://overpass.kumi.systems/api/interpreter',
            'https://overpass.openstreetmap.ru/api/interpreter'
        ];

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const time = new Date().toLocaleTimeString();
            element.innerHTML += `<div class="${type}">[${time}] ${message}</div>`;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function testServers() {
            clearLog('serverResult');
            log('serverResult', 'Testing all Overpass API servers...', 'info');

            for (let i = 0; i < servers.length; i++) {
                try {
                    log('serverResult', `\nTesting server ${i + 1}: ${servers[i]}`, 'info');
                    
                    const startTime = Date.now();
                    const response = await fetch(servers[i], {
                        method: 'POST',
                        body: '[out:json];node(1);out;',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    });
                    const endTime = Date.now();

                    if (response.ok) {
                        const data = await response.json();
                        log('serverResult', `âœ“ Server ${i + 1} WORKING (${endTime - startTime}ms)`, 'success');
                        log('serverResult', `Response: ${JSON.stringify(data).substring(0, 100)}...`, 'info');
                    } else {
                        log('serverResult', `âœ— Server ${i + 1} FAILED - HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log('serverResult', `âœ— Server ${i + 1} ERROR: ${error.message}`, 'error');
                }
            }
        }

        async function testSimpleQuery() {
            clearLog('simpleResult');
            log('simpleResult', 'Running simple query...', 'info');

            const query = '[out:json];node(1);out;';
            log('simpleResult', 'Query: ' + query, 'info');

            for (let i = 0; i < servers.length; i++) {
                try {
                    log('simpleResult', `\nTrying server ${i + 1}...`, 'info');
                    
                    const response = await fetch(servers[i], {
                        method: 'POST',
                        body: query
                    });

                    if (response.ok) {
                        const data = await response.json();
                        log('simpleResult', `âœ“ SUCCESS on server ${i + 1}`, 'success');
                        log('simpleResult', `Data: ${JSON.stringify(data, null, 2)}`, 'info');
                        return;
                    }
                } catch (error) {
                    log('simpleResult', `âœ— Failed on server ${i + 1}: ${error.message}`, 'error');
                }
            }

            log('simpleResult', 'âœ— All servers failed', 'error');
        }

        async function testRealSearch() {
            clearLog('realResult');
            log('realResult', 'Searching for supermarkets near Manhattan...', 'info');

            const lat = 40.7128;
            const lon = -74.0060;
            const radius = 5000; // 5km

            const query = `
                [out:json][timeout:25];
                (
                    node["shop"="supermarket"](around:${radius},${lat},${lon});
                    way["shop"="supermarket"](around:${radius},${lat},${lon});
                );
                out center;
            `;

            log('realResult', 'Query: ' + query.trim(), 'info');

            for (let i = 0; i < servers.length; i++) {
                try {
                    log('realResult', `\nTrying server ${i + 1}: ${servers[i]}`, 'info');
                    
                    const startTime = Date.now();
                    const response = await fetch(servers[i], {
                        method: 'POST',
                        body: query,
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    });
                    const endTime = Date.now();

                    log('realResult', `Response status: ${response.status} (${endTime - startTime}ms)`, 'info');

                    if (response.ok) {
                        const data = await response.json();
                        const count = data.elements?.length || 0;
                        log('realResult', `âœ“ SUCCESS! Found ${count} stores`, 'success');
                        
                        if (count > 0) {
                            log('realResult', 'First 3 stores:', 'info');
                            data.elements.slice(0, 3).forEach((store, idx) => {
                                const name = store.tags?.name || 'Unnamed';
                                log('realResult', `  ${idx + 1}. ${name} (${store.lat}, ${store.lon})`, 'info');
                            });
                        }
                        return;
                    } else {
                        const errorText = await response.text();
                        log('realResult', `âœ— HTTP Error: ${errorText.substring(0, 200)}`, 'error');
                    }
                } catch (error) {
                    log('realResult', `âœ— Failed on server ${i + 1}: ${error.message}`, 'error');
                }
            }

            log('realResult', 'âœ— All servers failed', 'error');
        }

        async function testCustomQuery() {
            clearLog('customResult');
            
            const lat = parseFloat(document.getElementById('lat').value);
            const lon = parseFloat(document.getElementById('lon').value);
            const radius = parseFloat(document.getElementById('radius').value);
            const category = document.getElementById('category').value;

            log('customResult', `Searching for ${category} near (${lat}, ${lon}) radius ${radius}m`, 'info');

            const query = `
                [out:json][timeout:25];
                (
                    node["shop"="${category}"](around:${radius},${lat},${lon});
                    way["shop"="${category}"](around:${radius},${lat},${lon});
                    node["amenity"="${category}"](around:${radius},${lat},${lon});
                    way["amenity"="${category}"](around:${radius},${lat},${lon});
                );
                out center;
            `;

            log('customResult', 'Query: ' + query.trim(), 'info');

            for (let i = 0; i < servers.length; i++) {
                try {
                    log('customResult', `\nTrying server ${i + 1}...`, 'info');
                    
                    const response = await fetch(servers[i], {
                        method: 'POST',
                        body: query
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const count = data.elements?.length || 0;
                        log('customResult', `âœ“ Found ${count} results`, 'success');
                        
                        if (count > 0) {
                            log('customResult', `Sample results (first 5):`, 'info');
                            data.elements.slice(0, 5).forEach((item, idx) => {
                                const name = item.tags?.name || 'Unnamed';
                                const type = item.tags?.shop || item.tags?.amenity || 'unknown';
                                log('customResult', `  ${idx + 1}. ${name} [${type}]`, 'info');
                            });
                        } else {
                            log('customResult', 'No results found. Try:', 'info');
                            log('customResult', '- Increasing radius', 'info');
                            log('customResult', '- Different category (cafe, restaurant, pharmacy)', 'info');
                            log('customResult', '- Different location', 'info');
                        }
                        return;
                    }
                } catch (error) {
                    log('customResult', `âœ— Error: ${error.message}`, 'error');
                }
            }
        }

        // Auto-run server test on page load
        window.onload = function() {
            testServers();
        };
    </script>
</body>
</html>
